<Graph ClassName="MailchimpContactMaint" Source="#CDATA" IsNew="True" FileType="ExistingGraph">
    <CDATA name="Source"><![CDATA[using System;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using System.Globalization;
using System.Linq;
using System.Runtime.CompilerServices;
using PX.Common;
using PX.Data;
using PX.Objects.AR;
using PX.Objects.CR.MassProcess;
using PX.Objects.GL;
using PX.Objects.CS;
using PX.Objects.EP;
using PX.SM;
using PX.Objects;
using PX.Objects.CR;
using MailchimpPXLib;
using MC = MailChimp.Net.Models;

namespace Mailchimp
{
  public class ContactMaint_Extension : PXGraphExtension<ContactMaint>
  {

        public PXSelect<CRSetup> Setup;

        public override void Initialize()
        {
            // Sort by StartDate (default is CreatedDateTime) so Mailchimp Activities are in sequence with pre-existing Acumatica Activites
            Base.Activities.OrderByNew<OrderBy<Desc<CRActivity.startDate>>>(); 
        }

        public void UpdateMailchimpStatus(Contact contact)
        {
            Base.ContactCurrent.Current = contact;
            ContactExt ext = contact.GetExtension<ContactExt>();

            var manager = GetManager();
            var member = manager.GetMember(ext.UsrMailchimpListID, contact.EMail);

            ext.UsrMailchimpListStatus = member.Status.ToString();
            Base.ContactCurrent.Update(contact);
            Base.Save.Press();
        }

        // Given a Contact maintenance page, return a Mailchimp manager
        public MailchimpPXManager GetManager()
        {
            CRSetup setup = Base.Setup.Current;
            CRSetupExt setupExt = setup.GetExtension<CRSetupExt>();

            var apiKey = setupExt.UsrMailchimpAPIKey;
            return new MailchimpPXManager(apiKey);
        }

        
        public PXAction<Contact> syncMailchimpStatus;
        [PXProcessButton]
        [PXUIField(DisplayName = "Sync Mailchimp")]
        protected virtual IEnumerable SyncMailchimpStatus(PXAdapter adapter)
        {
            foreach (Contact contact in adapter.Get())
            {
                this.Base.Actions.PressSave();

                PXLongOperation.StartOperation(Base, delegate ()
                {
                    ContactMaint graph = PXGraph.CreateInstance<ContactMaint>();
                    ContactMaint_Extension graphExt = graph.GetExtension<ContactMaint_Extension>();
                    graphExt.UpdateMailchimpStatus(contact);
                });

                yield return contact;
            }
        }

        #region Get Mailchimp Activities

        List<MC.Activity> activityList = new List<MC.Activity>();

        public void UpdateMailchimpActivities(Contact contact)
        {
            Base.ContactCurrent.Current = contact;
            ContactExt ext = contact.GetExtension<ContactExt>();

            var manager = GetManager();
            EPActivityType activityType = GetOrCreateMailchimpActivityType();

            // TODO - make sure the contact is on a mailchimp list before trying to get activities
            // TODO - do I need to make sure the contact is no null before doing anything?

            try
            {
                CRMailchimpList list = PXSelect<CRMailchimpList,
                    Where<CRMailchimpList.listID, Equal<Required<CRMailchimpList.listID>>>>.Select(Base, ext.UsrMailchimpListID);

                var activities = manager.GetActivities(list.ListID, Base.Contact.Current.EMail);
                if (activities != null)
                {
                    RegisterActivities(activities.ToList(), activityType);
                }

            }
            catch (Exception ex)
            {
                throw ex.InnerException;
            }

            Base.ContactCurrent.Update(contact);
            Base.Save.Press();
        }

        public PXAction<Contact> syncMailchimpActivities;
        [PXButton(CommitChanges = true)]
        [PXUIField(DisplayName = "Sync MC Activities")]
        protected virtual IEnumerable SyncMailchimpActivities(PXAdapter adapter)
        {
            foreach (Contact contact in adapter.Get())
            {
                this.Base.Actions.PressSave();

                PXLongOperation.StartOperation(Base, delegate ()
                {
                    ContactMaint graph = PXGraph.CreateInstance<ContactMaint>();
                    ContactMaint_Extension graphExt = graph.GetExtension<ContactMaint_Extension>();
                    graphExt.UpdateMailchimpActivities(contact);
                });

                yield return contact;
            }
        }

        // NB: This is a development tool that should be commented out before putting on production -- having the ability to delete and re-pull MC activities will help with testing/development
        public PXAction<Contact> deleteMailchimpActivities;
        [PXButton(CommitChanges = true)]
        [PXUIField(DisplayName = "Delete MC Activities")]
        protected void DeleteMailchimpActivities()
        {
            EPActivityType mCActivityType = GetOrCreateMailchimpActivityType(); 

            foreach(CRPMTimeActivity acumaticaActivity in Base.Activities.Select().RowCast<CRPMTimeActivity>().Where(ac => ac.Type == mCActivityType.Type))
            {
                Base.Activities.Delete(acumaticaActivity);
            }
        }

        private EPActivityType GetOrCreateMailchimpActivityType()
        {
            EPActivityType mailChimpActivityType = new EPActivityType();
            CRActivitySetupMaint graph = PXGraph.CreateInstance<CRActivitySetupMaint>();

            EPActivityType existingType = PXSelect<EPActivityType,
                Where<EPActivityType.type, Equal <Required<EPActivityType.type>>>>.Select(Base, MailchimpActivityType.MC);

            if (existingType != null)
            {
                mailChimpActivityType = existingType; // TODO: should we make sure this is active or update any other fields here?
            }
            else
            {
                mailChimpActivityType.Type = MailchimpActivityType.MC;
                mailChimpActivityType.Description = "Mailchimp";
                mailChimpActivityType.Active = true;
                mailChimpActivityType.ImageUrl = "main@Activity";
                mailChimpActivityType.Incoming = true;
                mailChimpActivityType.Outgoing = true;
                mailChimpActivityType.IsInternal = false; // With IsInternal marked as false, will not be an option under the Add Activities menu of the Activities tab

                graph.ActivityTypes.Insert(mailChimpActivityType);
                graph.Actions.PressSave();
            }

            return mailChimpActivityType;
        }

        // Check to see if the Mailchimp activity already exists
        public bool ActivityExists(MC.Activity activity)
        {
            EPActivityType mCActivityType = GetOrCreateMailchimpActivityType();

            TextInfo textInfo = new CultureInfo("en-US", false).TextInfo;
            string titleCasedAction = textInfo.ToTitleCase(activity.Action.ToLower());

            // TODO - do we want to change this to just say get everything greater than the latest timestamp? 
            // Maybe more efficient. But there is the potential for someone to delete mailchimp activities after they are pulled into Acumatica, so maybe a full check is good?
            foreach (CRActivity acumaticaActivity in Base.Activities.Select()) 
            {
                CRActivityExt acumaticaActivityExt = acumaticaActivity.GetExtension<CRActivityExt>();

                // if it's a MailChimp type activity and the timestamp and action match, assume it's the same activity and has already been pulled into Acumatica
                if (acumaticaActivity.Type == mCActivityType.Type && activity.Timestamp == acumaticaActivityExt.UsrMailchimpTimestamp && titleCasedAction == acumaticaActivityExt.UsrMailchimpAction)
                    return true; // activity already exists in Acumatica

                // TODO this breaks if the timestamp is null on the acumatica activity (which it might be on unubscribes?)
                // TODO - the unsubscribe and subscribe activities are strange. They sort of show up in the feed but sort of not. Maybe we need to deal with those in a different way?

            }

            return false; // activity doesn't exist in Acumatica
        }

        public void RegisterActivities(List<MC.Activity> result, EPActivityType activityType)
        {
            bool isInserted = false;
            CRActivityMaint graph = PXGraph.CreateInstance<CRActivityMaint>();

            // Insert activities in order from earliest to latest so that more recent activities are shown at the top of the Activities tab for the contact
            result = result.OrderBy(n => n.Timestamp).ToList();

            foreach (MC.Activity activity in result)
            {
                 //Check if it already exist by UsrMCTimestamp
                if (!ActivityExists(activity))
                {
                    //Insert Activity to Acumatica
                    CRActivity cRActivity = new CRActivity();
                    CRActivityExt ext = PXCache<CRActivity>.GetExtension<CRActivityExt>(cRActivity);

                    TextInfo textInfo = new CultureInfo("en-US", false).TextInfo;
                    DateTime parsedDateTime = DateTime.ParseExact(activity.Timestamp, "yyyy-MM-ddTHH:mm:sszzzz", CultureInfo.InvariantCulture);

                    cRActivity.Type = activityType.Type;
                    cRActivity.Subject = CreateActivitySubject(activity.Action, activity.Title);  
                    cRActivity.ContactID = Base.Contact.Current.ContactID;
                    cRActivity.BAccountID = Base.Contact.Current.BAccountID;
                    cRActivity.StartDate = parsedDateTime;
                    cRActivity.RefNoteID = Base.Contact.Current.NoteID;

                    ext.UsrMailchimpAction = textInfo.ToTitleCase(activity.Action.ToLower());
                    ext.UsrMailchimpCampaignID = activity.CampaignId;
                    ext.UsrMailchimpTimestamp = activity.Timestamp;
                    //ext.UsrMailchimpClickURL = activity.Url; // TODO - URL is not currently being returned from Mailchimp. To get it, we would need to extend the package

                    cRActivity = graph.Activities.Insert(cRActivity);
                    isInserted = true;

                }
            }
            if (isInserted)
                graph.Actions.PressSave();
        }

        private string CreateActivitySubject(string action, string title) 
        {
            action = mailChimpActionDict.ContainsKey(action) ? mailChimpActionDict[action] : action;
            string subject = action + title;

            return subject;
        }

        private readonly Dictionary<string, string> mailChimpActionDict = new Dictionary<string, string>()
        {
            {"sent", "Was Sent the email " },
            {"open", "Opened the email " },
            {"click", "Clicked on a link from the email " },
            {"bounce", "Bounced email " },
            {"unsub", "Unsubscribed" }

        };

        #endregion

        #region Event Handlers

        #endregion
    }
}]]></CDATA>
</Graph>