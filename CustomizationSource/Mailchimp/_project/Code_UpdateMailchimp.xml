<Graph ClassName="UpdateMailchimp" Source="#CDATA" IsNew="True" FileType="NewGraph">
    <CDATA name="Source"><![CDATA[using System;
using System.Collections.Generic;
using PX.Data;
using PX.Objects.CR;

namespace Mailchimp
{
  public class UpdateMailchimp : PXGraph<UpdateMailchimp>
  {
        //public PXSave<Contact> Save;
        public PXCancel<Contact> Cancel;
        public PXProcessing<Contact, Where<ContactExt.usrMailchimpListID, IsNotNull>> Contacts;

        public PXFilter<ContactMailchimpProcessFilter> ProcessFilter;
        //public PXFilter<DetailsTable> DetailsView;

        [Serializable]
        public class ContactMailchimpProcessFilter : IBqlTable
        {
            #region Action
            public abstract class action : PX.Data.IBqlField
            {
            }
            protected string _Action;
            [PXAutomationMenu]
            public virtual string Action
            {
                get
                {
                    return this._Action;
                }
                set
                {
                    this._Action = value;
                }
            }
            #endregion
        }

        /* [Serializable]
         public class DetailsTable : IBqlTable
         {

         }*/

        public static void Process(List<Contact> contacts)
        {
            var graph = PXGraph.CreateInstance<ContactMaint>();
            //bool errorOccurred = false;
            
            ContactExt ext;
            ContactMaint_Extension graphExt = graph.GetExtension<ContactMaint_Extension>();
            
            var manager = graphExt.GetManager();
            
            // TODO Update the Mailchimp Lists table first
            
            foreach (var contact in contacts)
            {
                ext = contact.GetExtension<ContactExt>();
                var member = manager.GetMember(ext.UsrMailchimpListID, contact.EMail);

                graphExt.SetMailchimpStatus(contact, member.Status.ToString());

                PXProcessing.SetInfo(String.Format(
                    "Contact {0} has been updated.",
                    contact.DisplayName));
            }
        }

        public UpdateMailchimp()
        {
            Contacts.SetProcessDelegate(Process);
        }
    }
}]]></CDATA>
</Graph>